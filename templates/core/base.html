{%load static core_tags%}
<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    <head>
        {%block cdn%}
            <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />

            <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>                    
            <script src="{% static 'js/jquery-3.6.0.js' %}"></script>                    
            <script src="{% static 'js/popper.min.js' %}"></script>                    
            <script src="{% static 'js/fontawesome.js' %}"></script>  
            <script src="{% static 'js/htmx.min.js' %}"></script>  
            <script src="{% static 'js/palette.js' %}"></script>        
            <link href="{% static 'css/snackbar.css' %}" rel="stylesheet" />
            <script src="{% static 'js/snackbar.js' %}"></script> 
            <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js"></script>
            
            <link rel="stylesheet" type="text/css"  href="{% static 'css/side_bar.css' %}">
            <link rel="stylesheet" type="text/css"  href="{% static 'css/base.css' %}">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css" />
           {%endblock cdn%}

        {%block scripts%}
        <audio id="notification1" src="{% static 'audio/notification1.wav' %}" preload="auto"></audio>
        <audio id="notification2" src="{% static 'audio/notification2.mp3' %}" preload="auto"></audio>
        <script>
            
            function fallbackCopyTextToClipboard(text) {
                var textArea = document.createElement("textarea");
                textArea.value = text;
                
                // Avoid scrolling to bottom
                textArea.style.top = "0";
                textArea.style.left = "0";
                textArea.style.position = "fixed";
              
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
              
                try {
                  var successful = document.execCommand('copy');
                  var msg = successful ? 'successful' : 'unsuccessful';
                  if (msg == 'successful') {
                    snackbarShow('Successfully copied free taster link', 'success')
                  } else {
                    snackbarShow('Failed to copy free taster link', 'danger')
                  }
                } catch (err) {
                }
              
                document.body.removeChild(textArea);
              }

              function inlinePreventDefault(e) {
                  e.preventDefault();
              }
              
              function copyTextToClipboard(text) {
                if (!navigator.clipboard) {
                  fallbackCopyTextToClipboard(text);
                  return;
                }
                navigator.clipboard.writeText(text).then(function() {
                    snackbarShow('Successfully copied free taster link', 'success')
                }, function(err) {
                    snackbarShow('Failed to copy free taster link', 'danger')
                });
              }
            </script>
            
            <script>
                let dt = null;
                $(document).ready(function() {
                    $("[data-bs-toggle=popover]").popover();
                    document.body.addEventListener('htmx:afterRequest', function(evt) {   
                        if (evt.detail.target.id == 'generic_modal_body'){
                            $('#generic_modal').modal('show');
                        }
                        if (![undefined, ''].includes(evt.detail.pathInfo.path)){
                            if (evt.detail.pathInfo.path.includes("modify-user")){
                                $('#generic_modal').modal('hide');
                                snackbarShow('Successfully modifed/added user', 'success')
                            }
                        }
                        if (evt.detail.xhr.status == 200){
                        } else {
                            snackbarShow(evt.detail.xhr.responseText, 'danger')
                        }
                        $('.popover').remove()
                        $('[data-bs-toggle=popover]').popover();
                        $('[data-bs-toggle=popover_delay]').popover({
                            delay: { 
                               show: "350", 
                               hide: "100"
                            }
                        });
                    });     
                    
                    document.body.addEventListener('htmx:afterRequest', function(evt) {                          
                        let status = evt.detail.xhr.status;
                        let srcElement = $(evt.srcElement);
                        let src_id = srcElement.attr('id');
                        if(status == 200) {
                            if (![undefined, ''].includes(evt.detail.pathInfo.path)){
                                if (evt.detail.pathInfo.path.includes("login")){
                                    window.location.replace("/");
                                }
                            }
                            if (![undefined, ''].includes(evt.detail.pathInfo.requestPath)){
                                if (evt.detail.pathInfo.requestPath.includes("login-htmx")){
                                    snackbarShow('Successfully logged in', 'success');
                                    location.reload();;
                                }else if (evt.detail.pathInfo.requestPath.includes("modify-user")){
                                    snackbarShow('Successfully logged in', 'success');
                                    location.reload();;
                                }
                            }
                        } else if (status == 404) {
                            if ($('#'+src_id+"_error").length == 0){                                
                                $("#"+src_id).after("<div id='"+src_id+"_error' style='color:red'>Not Found</div>");
                            } else {                                
                                $('#'+src_id+"_error").html("<div id='"+src_id+"_error' style='color:red'>Not Found</div>");
                            }
                        }else if (status == 500){
                            snackbarShow('Error: '+evt.detail.xhr.response, 'danger')           
                        }
                    });                    
                    

                    document.body.addEventListener('htmx:configRequest', function(evt) {    
                        evt.detail.headers['x-csrftoken'] = '{{csrf_token}}';
                    });
                });
            </script>
        {%endblock scripts%}

        {%block styles%}
        <style>
              
        </style>
        {%endblock styles%}
        
    </head>

    <body class="cartoon-background" style="height:auto">
        <nav class="navbar navbar-expand-lg navbar-light bg-dark" id="topnav">
            <div class="container-fluid ">
                <a class="navbar-brand p-0" href="{%url 'customer-home'%}">
                    <img class="side_nav_logo" src="{% static 'img/logo-dark-back-img.png' %}" style="height:5vh" alt="winser systems logo">
                </a>
                <a class="navbar-brand p-0" href="{%url 'customer-home'%}">
                <img class="side_nav_logo" src="{% static 'img/logo-dark-back-text.png' %}" style="height:2.25vh" alt="winser systems logo">
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    {% comment %} <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item ">
                        <a class="nav-link active text-white" aria-current="page" href="{%url 'customer-home'%}">Home</a>
                    </li>
                    </ul> {% endcomment %}

                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item ">
                        <img  class="top-htmx-indicator htmx-indicator" id="top-htmx-indicator" src="https://htmx.org/img/bars.svg"/>
                    </li>
                    </ul>
                    
                    {%include 'core/htmx/profile-nav-section.html'%}
                </div>
            </div>
        </nav>
        <div class="container-fluid  p-0">
            <div class="row  mt-2">
                {%block extra_top_left_buttons %}
                {%endblock extra_top_left_buttons %}

                <div class="col">
                </div>

                {%block extra_top_right_buttons %}                    
                {%endblock extra_top_right_buttons %}
            </div>
            <div class="row ">
                <div class="col" style=""> 
                    {%block content%} 
                    {%endblock content%}
                </div>
            </div>
        </div>

        <div class="modal fade" id="generic_modal" role="dialog" style="overflow:hidden;display: none;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="generic_modal_title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true"></span>
                        </button>
                    </div> 
                    <div class="modal-body" id="generic_modal_body">
                    </div>
                </div>
            </div>
        </div>
        {%block snackbar%}
        <div id="snackbar"></div>

        {%block chat_bottom%}
            <script>  

            $(document).ready(function() {
                document.body.addEventListener('htmx:afterSwap', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("message-window")){
                        let element = $(evt.target.lastElementChild).find(".chat_card_body");
                        try{
                            element.scrollTop(element[0].scrollHeight - element[0].clientHeight);
                        }catch(e){console.log(e)}
                    }
                });
                
                document.body.addEventListener('htmx:beforeRequest', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("get-more-messages")){
                    }
                });
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("get-more-messages")){
                    }
                });
                
                document.body.addEventListener('htmx:oobAfterSwap', function(evt) { 
                    if ($(evt.detail.target).hasClass('chat_card_body')){                        
                        $(evt.detail.target).animate({
                            scrollTop: $(evt.detail.target)[0].scrollHeight - $(evt.detail.target)[0].clientHeight
                        }, 100);
                    }
                    $("[data-bs-toggle=popover]").popover();
                });
                document.body.addEventListener('htmx:oobBeforeSwap', function(evt) { 
                    {% comment %} console.log("oobBeforeSwap", evt) {% endcomment %}
                    if ($(evt.target).hasClass('message_list_body')){
                        console.log(2)
                        document.getElementById('notification1').play();
                        htmx.ajax('GET', "{%url 'update-message-counts'%}", {swap:'none'})
                    }
                    $("[data-bs-toggle=popover]").popover();
                });
                
                document.body.addEventListener('htmx', function(evt) { 
                    
                });

                $('#generic_modal').on('hidden.bs.modal', function () {
                    $('#generic_modal_body').html("")
                })
        
                window.addEventListener("message", function(e) {
                    if(isCalendlyEvent(e)) {
                        console.log(e);
                        $('#calendly_loading').remove()
                        if (e.data.event == "calendly.event_scheduled") {               
                            var respStatus = $.ajax({
                                type:'POST',
                                url:'{%url "calendly-booking-success"%}',
                                data:{'lead_pk':$('#modal_lead_pk').val(), 'uri':e.data.payload.event.uri, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                                success: function (data) {
                                },
                                error: function(XMLHttpRequest, textStatus, errorThrown) {
                                }
                            })
                        }
                    }
                });
            });
        
            function isCalendlyEvent(e) {
                return e.origin === "https://calendly.com" && e.data.event && e.data.event.indexOf("calendly.") === 0;
            };
            </script>
        {%endblock chat_bottom%}
        {%if request.user.is_authenticated%}
        <span id="chat_bottom" class="" style=" 
            display: flex;
            flex-wrap: wrap;
            align-items: flex-start;">
            <span
            hx-get="{%url 'get-messaging-window'%}"
            hx-target="#chat_bottom"
            hx-swap="#outerHTML"
            hx-indicator=".htmx-indicator"        
            hx-trigger="load"></span>
        </span>
        {%endif%}

        {%endblock snackbar%}
        
    </body>
</html>

