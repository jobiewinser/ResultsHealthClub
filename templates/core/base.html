{%load static core_tags%}
<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    <div id="leadsSearchBar">
    Search Here: <input type="search" id="searchInput" class="search" />
    </div>
    
    <head>
        <script>
            var csrftoken = '{{ csrf_token }}';
        </script>
        <link rel="shortcut icon" type="image/png" href="{% static 'img/logo-dark-back-img.png' %}"/>
        {%block cdn%}
            <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />

            <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>                    
            <script src="{% static 'js/jquery-3.6.0.js' %}"></script>                    
            <script src="{% static 'js/popper.min.js' %}"></script>                    
            <script src="{% static 'js/fontawesome.js' %}"></script>  
            <script src="{% static 'js/htmx.min.js' %}"></script>  
            <script src="{% static 'js/palette.js' %}"></script>        
            <link href="{% static 'css/snackbar.css' %}" rel="stylesheet" />
            <script src="{% static 'js/snackbar.js' %}"></script> 
            <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js"></script>
            <link href="{% static 'css/datatables.css' %}" rel="stylesheet" />
            <script src="{% static 'js/datatables.js' %}"></script> 
            
            <link rel="stylesheet" type="text/css"  href="{% static 'css/side_bar.css' %}">
            <link rel="stylesheet" type="text/css"  href="{% static 'css/base.css' %}">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css" />
           {%endblock cdn%}
        
        <link href="{% static 'css/drag_drop.css' %}" rel="stylesheet" />
        <script src="{% static 'js/drag_drop.js' %}"></script> 

        <script src="{% static 'js/base.js' %}"></script>
        <script src="{% static 'js/modules/leads.js' %}"></script>
        <script src="{% static 'js/modules/booking.js' %}"></script>
        <script src="{% static 'js/modules/analytics.js' %}"></script>
        <script src="{% static 'js/modules/free_tasters.js' %}"></script>
        <script src="{% static 'js/modules/company_configuration.js' %}"></script>
        <script src="{% static 'js/modules/whatsapp_templates.js' %}"></script>
        <script src="{% static 'js/modules/whatsapp_template_edit.js' %}"></script>
        
        <audio id="notification1" src="{% static 'audio/notification1.wav' %}" preload="auto"></audio>
        <audio id="notification2" src="{% static 'audio/notification2.mp3' %}" preload="auto"></audio>
        
        {%block styles%}
        <style>
              
        </style>
        {%endblock styles%}
        
    </head>
    
    <script>  
            

        $(document).ready(function() {
            
            function handlehtmxafterSwap(evt){
                var current_module = $('#current_page').val()
                if (current_module == 'analytics_overview'){
                    analyticshandlehtmxafterSwap(evt);                    
                } else if (current_module == 'campaign_booking_overview'){
                    bookinghandlehtmxafterSwap(evt);                    
                } else if (current_module == 'free_tasters'){
                    freetastershandlehtmxafterSwap(evt);                    
                } else if (current_module == 'whatsapp_templates'){
                    whatsapptemplateshandlehtmxafterSwap(evt);                    
                }                
                basehandlehtmxafterSwap(evt);
            }
            document.body.addEventListener('htmx:afterSwap', handlehtmxafterSwap);
            
            function handlehtmxafterRequest(evt){
                var current_module = $('#current_page').val()
                if (current_module == 'analytics_overview'){
                    companyconfigurationhandlehtmxafterRequest(evt);
                } else if (current_module == 'campaign_leads_overview'){
                    leadshandlehtmxafterSwap(evt);
                } else if (current_module == 'whatsapp_templates'){
                    whatsapptemplateshandlehtmxafterRequest(evt);                    
                }
                basehandlehtmxafterRequest(evt);
            }
            document.body.addEventListener('htmx:afterRequest', handlehtmxafterRequest);

            function handlehtmxbeforeRequest(evt){
                var current_module = $('#current_page').val();
                if (current_module == 'campaign_leads_overview'){
                    leadshandlehtmxbeforeRequest(evt);
                } else if (current_module == 'free_tasters'){
                    freetastershandlehtmxbeforeRequest(evt);                    
                }
            }
            document.body.addEventListener('htmx:beforeRequest', handlehtmxbeforeRequest);
            
            function handlehtmxoobAfterSwap(evt){
                var current_module = $('#current_page').val()
                basehandlehtmxoobAfterSwap(evt);
            }
            document.body.addEventListener('htmx:oobAfterSwap', handlehtmxoobAfterSwap);
            
            function handlehtmxoobBeforeSwap(evt){
                var current_module = $('#current_page').val()
                basehandlehtmxoobBeforeSwap(evt);
            }
            document.body.addEventListener('htmx:oobBeforeSwap', handlehtmxoobBeforeSwap);
            
            function handlehtmxconfigRequest(evt){ 
                evt.detail.headers['x-csrftoken'] = '{{csrf_token}}';
            }
            document.body.addEventListener('htmx:configRequest', handlehtmxconfigRequest);
            
            

            $('#generic_modal').on('hidden.bs.modal', function () {
                $('#generic_modal_body').html("")
            })
    
            window.addEventListener("message", function(e) {
                if(isCalendlyEvent(e)) {
                    $('#calendly_loading').remove()
                    if (e.data.event == "calendly.event_scheduled") {               
                        var respStatus = $.ajax({
                            type:'POST',
                            url:'{%url "calendly-booking-success"%}',
                            data:{'lead_pk':$('#modal_lead_pk').val(), 'uri':e.data.payload.event.uri, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                            success: function (data) {
                            },
                            error: function(XMLHttpRequest, textStatus, errorThrown) {
                            }
                        })
                    }
                }
            });
        });
        window.onload = function() {
            var listen = /^[a-z0-9]+$/i;
            var searchInput = document.getElementById('searchInput');
            var searchBar = document.getElementById('leadsSearchBar');
        
            if ( window.addEventListener ){
                window.addEventListener( 'keyup', insertKey, false);
            }
            function insertKey( e ) {
                if (!$('input').is(':focus')) {
                // Get the character from e.keyCode
                    var key = String.fromCharCode( e.keyCode ).toLowerCase(); 
            
                    // Match the character  
                    if( key.match(listen)) {
            
                        // Change display: none; to display: block;
                        searchBar.style.display = "block";
                        $(searchBar).stop( true, true ).fadeIn();
                        // Append every new character
                        searchInput.value += key;

                        $(searchBar).stop( true, true ).fadeOut("slow", function () {
                            $(this).css({display:"none"});
                        });
                    } else if(e.keyCode == 8){
                        searchInput.value = "";
                    }

                    if (searchInput.value != ""){
                        jQuery.expr[':'].containsLower = function(elem, i, m) {
                            let name_elem = $(elem).find('.lead_name');
                            let campaign_elem = $(elem).find('.campaign_name');
                            let site_elem = $(elem).find('.site_name');                        
                            let cost_elem = $(elem).find('.lead_cost');
                            let phone_elem = $(elem).find('.phone_number');
                            let search_term = m[3].toLowerCase();
                            return (
                                (name_elem.html().toLowerCase()).includes(search_term) ||
                                (campaign_elem.html().toLowerCase()).includes(search_term) ||
                                (site_elem.html().toLowerCase()).includes(search_term) ||
                                (cost_elem.html().toLowerCase()).includes(search_term) ||
                                (phone_elem.html().toLowerCase()).includes(search_term)
                            )
                        };

                        $('.column-drag').hide().filter(':containsLower("'+searchInput.value+'")').show();
                    } else {

                        $('.column-drag').show();
                    }

                    $('#leadSearchValue').html(searchInput.value)
                }
            }
        }
        $(document).ready(function() {
            window.onkeydown = function(e) { 
                return !(e.keyCode == 32 && e.target == document.body);
            }; 
            document.body.onkeyup = function(e) {
                if (e.key == " " ||
                    e.code == "Space" ||      
                    e.keyCode == 32      
                ) {
                    e.preventDefault();
                    let drag_elem = null;
                    let hover_elem = $(':hover').last();
                    if (hover_elem.hasClass('.column-drag')){
                        drag_elem = hover_elem;
                    } else{                    
                        drag_elem = hover_elem.closest('.column-drag');
                    }    
                    if (drag_elem.length != 0)  {  
                        htmx.ajax('GET', '/campaign-leads/toggle-claim-lead/'+drag_elem.data('id')+'/', {swap:"none"})
                    }
                }
            }

            set_total_costs();
        });
    </script>
    <body class="cartoon-background">
        {%include 'core/nav.html'%}
        <div class="container-fluid pb-5" id="content" style="">  
            {%block content%} 
            {%endblock content%}
        </div>
        <img class="htmx-indicator" id="page_load_indicator" src="https://htmx.org/img/bars.svg"/>

        <div class="modal fade" id="generic_modal" role="dialog" style="overflow:hidden;display: none;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="generic_modal_title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true"></span>
                        </button>
                    </div> 
                    <div class="modal-body" id="generic_modal_body">
                    </div>
                </div>
            </div>
        </div>
        {%block snackbar%}
        <div id="snackbar"></div>

        {%block chat_bottom%}
        {%endblock chat_bottom%}
        {%if request.user.is_authenticated%}
        <span id="chat_bottom_wrapper">
            
            <img  class="htmx-indicator invert" id="chat_bottom_htmx_indicator" src="https://htmx.org/img/bars.svg"/>
            <span
            hx-get="{%url 'get-messaging-window'%}"
            hx-target="#chat_bottom_wrapper"
            hx-swap="#outerHTML"
            hx-indicator="#chat_bottom_htmx_indicator"        
            hx-trigger="load"></span>
        </span>
        {%endif%}

        {%endblock snackbar%}
        
    </body>
</html>

