{%load static core_tags%}
<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1">
<html>
    <head>
        <script>
            var csrftoken = '{{ csrf_token }}';
        </script>
        <link rel="shortcut icon" type="image/png" href="{% static 'img/logo-dark-back-img.png' %}"/>
        {%block cdn%}
            <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" />

            <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>                    
            <script src="{% static 'js/jquery-3.6.0.js' %}"></script>                    
            <script src="{% static 'js/popper.min.js' %}"></script>                    
            <script src="{% static 'js/fontawesome.js' %}"></script>  
            <script src="{% static 'js/htmx.min.js' %}"></script>  
            <script src="{% static 'js/palette.js' %}"></script>        
            <link href="{% static 'css/snackbar.css' %}" rel="stylesheet" />
            <script src="{% static 'js/snackbar.js' %}"></script> 
            <script type="text/javascript" src="https://assets.calendly.com/assets/external/widget.js"></script>
            <link href="{% static 'css/datatables.css' %}" rel="stylesheet" />
            <script src="{% static 'js/datatables.js' %}"></script> 
            
            <link rel="stylesheet" type="text/css"  href="{% static 'css/side_bar.css' %}">
            <link rel="stylesheet" type="text/css"  href="{% static 'css/base.css' %}">
            <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.0/font/bootstrap-icons.css" />
           {%endblock cdn%}
        {%include 'core/js_snippets/base_scripts.html'%}
        
        <link href="{% static 'css/drag_drop.css' %}" rel="stylesheet" />
        <script src="{% static 'js/drag_drop.js' %}"></script> 

        <script src="{% static 'js/modules/leads.js' %}"></script>
        <script src="{% static 'js/modules/booking.js' %}"></script>
        <script src="{% static 'js/modules/analytics.js' %}"></script>
        <script src="{% static 'js/modules/company_configuration.js' %}"></script>
        <script src="{% static 'js/modules/whatsapp_templates.js' %}"></script>
        <script src="{% static 'js/modules/whatsapp_template_edit.js' %}"></script>
        
        <audio id="notification1" src="{% static 'audio/notification1.wav' %}" preload="auto"></audio>
        <audio id="notification2" src="{% static 'audio/notification2.mp3' %}" preload="auto"></audio>

        {%block styles%}
        <style>
              
        </style>
        {%endblock styles%}
        
    </head>

    <body class="cartoon-background">
        {%include 'core/nav.html'%}
        <div class="container-fluid p-2" id="content">  
            {%block content%} 
            {%endblock content%}
        </div>
        <img class="htmx-indicator" id="page_load_indicator" src="https://htmx.org/img/bars.svg"/>

        <div class="modal fade" id="generic_modal" role="dialog" style="overflow:hidden;display: none;">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="generic_modal_title"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true"></span>
                        </button>
                    </div> 
                    <div class="modal-body" id="generic_modal_body">
                    </div>
                </div>
            </div>
        </div>
        {%block snackbar%}
        <div id="snackbar"></div>

        {%block chat_bottom%}
            <script>  

            $(document).ready(function() {
                document.body.addEventListener('htmx:afterSwap', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("message-window")){
                        let element = $(evt.target.lastElementChild).find(".chat_card_body");
                        try{
                            element.scrollTop(element[0].scrollHeight - element[0].clientHeight);
                        }catch(e){console.log(e)}
                    }
                });
                
                document.body.addEventListener('htmx:beforeRequest', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("get-more-messages")){
                    }
                });
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.pathInfo.requestPath.includes("get-more-messages")){
                    }
                });
                
                document.body.addEventListener('htmx:oobAfterSwap', function(evt) { 
                    if ($(evt.detail.target).hasClass('chat_card_body')){                        
                        $(evt.detail.target).animate({
                            scrollTop: $(evt.detail.target)[0].scrollHeight - $(evt.detail.target)[0].clientHeight
                        }, 100);
                    }
                    $("[data-bs-toggle=popover]").popover();
                });
                document.body.addEventListener('htmx:oobBeforeSwap', function(evt) { 
                    {% comment %} console.log("oobBeforeSwap", evt) {% endcomment %}
                    if ($(evt.target).hasClass('message_list_body')){
                        console.log(2)
                        document.getElementById('notification1').play();
                        htmx.ajax('GET', "{%url 'update-message-counts'%}", {swap:'none'})
                    }
                    $("[data-bs-toggle=popover]").popover();
                });
                
                document.body.addEventListener('htmx', function(evt) { 
                    
                });

                $('#generic_modal').on('hidden.bs.modal', function () {
                    $('#generic_modal_body').html("")
                })
        
                window.addEventListener("message", function(e) {
                    if(isCalendlyEvent(e)) {
                        console.log(e);
                        $('#calendly_loading').remove()
                        if (e.data.event == "calendly.event_scheduled") {               
                            var respStatus = $.ajax({
                                type:'POST',
                                url:'{%url "calendly-booking-success"%}',
                                data:{'lead_pk':$('#modal_lead_pk').val(), 'uri':e.data.payload.event.uri, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                                success: function (data) {
                                },
                                error: function(XMLHttpRequest, textStatus, errorThrown) {
                                }
                            })
                        }
                    }
                });
            });
        
            function isCalendlyEvent(e) {
                return e.origin === "https://calendly.com" && e.data.event && e.data.event.indexOf("calendly.") === 0;
            };
            </script>
        {%endblock chat_bottom%}
        {%if request.user.is_authenticated%}
        <span id="chat_bottom_wrapper">
            
            <img  class="htmx-indicator invert" id="chat_bottom_htmx_indicator" src="https://htmx.org/img/bars.svg"/>
            <span
            hx-get="{%url 'get-messaging-window'%}"
            hx-target="#chat_bottom_wrapper"
            hx-swap="#outerHTML"
            hx-indicator="#chat_bottom_htmx_indicator"        
            hx-trigger="load"></span>
        </span>
        {%endif%}

        {%endblock snackbar%}
        
    </body>
</html>

