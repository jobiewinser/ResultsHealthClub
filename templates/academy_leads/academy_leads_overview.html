{% extends 'core/overviews.html' %}
{%load static%}
{%block scripts%}
{{block.super}}
<script>
    $(document).ready(function() {  

        document.body.addEventListener('htmx:afterSwap', function(evt) {   
            if (evt.detail.xhr.status == 200){
                if (evt.detail.pathInfo.path.includes("mark-done")){
                    snackbarShow('Successfully marked lead as done', 'success')
                } else if (evt.detail.pathInfo.path.includes("add-booking")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully added a booking', 'success')
                } else if (evt.detail.pathInfo.path.includes("log-communication")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully logged a communication', 'success')
                } else if (evt.detail.pathInfo.path.includes("create-academy-lead")){
                    $('#refresh_results_table').click(); 
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully manually created an academy lead', 'success')
                } else if (evt.detail.pathInfo.path.includes("mark-arrived")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully marked that the customer arrived as booking', 'success')
                } else if (evt.detail.pathInfo.path.includes("mark-sold")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully sold to customer', 'success')
                } else if (evt.detail.pathInfo.path.includes("academy-leads-overview")){
                    $('#refresh_campaign_list_span').click(); 
                    snackbarShow('Successfully refreshed table', 'success')
                }                
            }
            if ($('#noteTable')){
                
            }
            
            $('[data-bs-toggle=popover]').popover();
        });
    });
    function initDataTable() {
        dt = $('#results_table').DataTable(            
        {  
            order: [[ 2, 'asc' ]],
            iDisplayLength: 10
        }
        );
    }
</script>
{%endblock scripts%}

{%block extra_top_left_buttons %}
<button hidden hx-get="{% url 'academy-leads-overview' %}" hx-push-url="true" hx-swap="outerHTML" hx-include=".non_site_dependant_results_table_filters" hx-target="#results_table" id="change_site" class="btn btn-primary btn-sm"></button>
{{block.super}}
<div class="col-md-auto" hx-get="{% url 'get-active-campaign-lists'%}" hx-include=".results_table_filters" hx-trigger="load" hx-target="#campaign_list_span" hx-swap="outerHTML">
    <span id="campaign_list_span">   
        <select class="form-select">
            <option>Loading</option>
        </select>    
    </span>
</div>
<button hidden hx-get="{% url 'get-active-campaign-lists'%}" hx-include=".results_table_filters" id="refresh_campaign_list_span" hx-target="#campaign_list_span" hx-trigger="click" hx-swap="outerHTML"></button>
<button hidden hx-get="{% url 'academy-leads-overview'%}" hx-include=".results_table_filters" id="refresh_results_table" hx-target="#results_table" hx-trigger="click" hx-swap="outerHTML"></button>
{%endblock%}

{%block extra_top_right_buttons %}
<div class="col-md-auto">
    <button class="btn btn-primary" 
        data-bs-toggle="popover" 
        data-bs-trigger="hover" 
        data-bs-placement="top"
        data-bs-content="Manually create an academy lead."
        hx-target="#generic_modal_body" 
        hx-include="#create_academy_lead,#site_pk"
        hx-get="{% url 'academy-lead-get-modal-content' %}" 
        hx-push-url="false"
        hx-swap="innerHTML" hx-indicator="#htmx-indicator" hx-trigger="click">
            <i class="fa fa-plus" aria-hidden="true"></i> Manually Add Academy Lead
    </button>
    <input type="text" style="display:None" id="create_academy_lead" name="template_name" value="create_academy_lead"/>
</div>
{%include 'academy_leads/htmx/academy_leads_table_status_toggle_div.html'%}
{%endblock%}

{%block table%}

<span hx-swap-oob="true" id="site_pk_span">   
    <input type="text" style="display:None" id="site_pk" name="site_pk" value="{{request.GET.site_pk}}"/>
</span>
<input type="text" style="display:None" id="log_communication" name="template_name" value="log_communication"/>
<input type="text" style="display:None" id="communication_history" name="template_name" value="communication_history"/>
<input type="text" style="display:None" id="booking_history" name="template_name" value="booking_history"/>
<input type="text" style="display:None" id="add_booking" name="template_name" value="add_booking"/>
<input type="text" style="display:None" id="pause_whatsapp" name="template_name" value="pause_whatsapp"/>
<br>
{% include 'academy_leads/htmx/academy_leads_table.html' %}
{%endblock table%}