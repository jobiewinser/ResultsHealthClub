{%load static core_tags%}
<script>
        $(document).ready(function() {          
            console.log({{request.session.open_chats|safe}})                
            const chatListSocket = new WebSocket(                            
                'ws{%if not 'DEBUG'|settings_value%}s{%endif%}://'+window.location.host+'/ws/chatlist/{{site.pk}}/'                            
            );
            chatListSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);
                $('#latest_message_avatar_'+data.whatsapp_number).attr("src", data.user_avatar);
                if (typeof data.user_name === 'string') {
                    $('#latest_message_name_'+data.whatsapp_number).html(data.user_name)
                } else {
                    $('#latest_message_name_'+data.whatsapp_number).html(data.whatsapp_number)
                }
                if (data.inbound) {
                    $('#latest_message_content_'+data.whatsapp_number).html("Them: " + data.message)
                    $('#latest_message_row_'+data.whatsapp_number).removeClass("inactive_chat_row")
                } else {                    
                    $('#latest_message_content_'+data.whatsapp_number).html("You: " + data.message)
                    $('#latest_message_row_'+data.whatsapp_number).addClass("inactive_chat_row")
                }                
            }

            document.body.addEventListener('htmx:afterSwap', function(evt) {   
                if (evt.detail.target.id == 'next_chat_window'){
                    let id = $(evt.srcElement).data('whatsapp-number');
                    if (id != undefined){
                        const user = "{{user.pk}}";
                        const site_pk = "{{site_pk}}";
                        console.log('#message_submit_'+id,$(evt.detail.elt))
                        document.querySelector('#message_submit_'+id).onclick = function (e) {
                            const messageInputDom = document.querySelector('#message_input_'+id);
                            const message = messageInputDom.value;

                            $(`<div class="row pending message_pending_`+id+`">
                                <div class="col p-0 ps-1 m-1 card">
                                    `+message+`
                                </div>
                                <div class="col-auto p-0 ps-1 m-1">
                                    <img src="`+"{{request.user.profile.avatar.url}}"+`" alt="" width="22" height="22" class="rounded-circle">
                                </div>
                            </div>`).insertBefore('#message_input_div_'+id);

                            chatSocket.send(JSON.stringify({
                                'message': message,
                                'user': user,
                                'site_pk': site_pk,
                            }));
                            messageInputDom.value = '';
                            $("#messageWindowCollapse_"+id).scrollTop($($("#messageWindowCollapse_"+id)).height() * 2);
                        };
                        
                        const chatSocket = new WebSocket(                            
                            'ws{%if not 'DEBUG'|settings_value%}s{%endif%}://'+window.location.host+'/ws/chat/'+id+'/{{site.pk}}/'                            
                        );
                        
                        chatSocket.onmessage = function (e) {
                            const data = JSON.parse(e.data);
                            let user_avatar = data.user_avatar
                            if (user_avatar == null) {
                                user_avatar = "{% static 'img/blank-profile-picture.png' %}"
                            }
                            if (data.inbound == true){
                                $(`<div class="row">
                                    <div class="col-auto p-0 ps-1 m-1">
                                        <img src="`+user_avatar+`" alt="" width="22" height="22" class="rounded-circle">
                                    </div>
                                    <div class="col p-0 ps-1 m-1 card">
                                        `+data.message+`
                                    </div>
                                </div>`).insertBefore('#message_input_div_'+id);
                                
                            } else{
                                let new_chat =  $(`<div class="row">
                                    <div class="col p-0 ps-1 m-1 card">
                                        `+data.message+`
                                    </div>
                                    <div class="col-auto p-0 ps-1 m-1">
                                        <img src="`+user_avatar+`" alt="" width="22" height="22" class="rounded-circle">
                                    </div>
                                </div>`);
                                if ($('.message_pending_'+id).length > 0){
                                    $('.message_pending_'+id).first().replaceWith(new_chat);
                                } else {                                
                                    new_chat.insertBefore('#message_input_div_'+id);
                                }
                            }
                            $("#messageWindowCollapse_"+id).scrollTop($($("#messageWindowCollapse_"+id)).height() * 2);
                        }
                    }
                    $("#messageWindowCollapse_"+id).scrollTop($($("#messageWindowCollapse_"+id)).height() * 2);
                }
            })
        })
        function clear_chat_from_session(whatsapp_number){
            var respStatus = $.ajax({
                type:'POST',
                url:'{%url "clear-chat-from-session"%}',
                data:{'whatsapp_number':whatsapp_number, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                success: function (data) {
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                }
            })
        }
        function add_chat_to_session(whatsapp_number){
            var respStatus = $.ajax({
                type:'POST',
                url:'{%url "add-chat-to-session"%}',
                data:{'whatsapp_number':whatsapp_number, 'csrfmiddlewaretoken':'{{ csrf_token }}'},
                success: function (data) {
                },
                error: function(XMLHttpRequest, textStatus, errorThrown) {
                }
            })
        }
        
</script>
<link href="{% static 'css/chat.css' %}" rel="stylesheet" />
    <span id="next_chat_window"></span>
    {%if site%}
    <div class="card chat_bottom_window p-0">
        <div class="card-header chat_bottom_header collapsed center " data-bs-toggle="collapse" data-bs-target="#messageCollapse" aria-expanded="false" aria-controls="messageCollapse">
            <b>Chats for {{site.name}}</b>
        </div>
        <div class="card-body collapse p-0 all_chat_card_body" id="messageCollapse">
                {%for message in site.get_fresh_messages%}
                <div class="row chat_row {%if message.inbound%}active_chat_row{%else%}inactive_chat_row{%endif%}"
                hx-get="{%url 'message-window' customer_number=message.customer_number chat_box_site_pk=site.pk%}"
                hx-indicator=".top-htmx-indicator" 
                hx-target="#next_chat_window"
                hx-push-url="false"
                hx-swap="outerHTML" hx-trigger="click"  
                data-whatsapp-number="{{message.customer_number}}"
                id="latest_message_row_{{message.customer_number}}"
                onclick="add_chat_to_session({{message.customer_number}})" 
                >
                    <div class="col-auto p-0">
                        <img id="latest_message_avatar_{{message.customer_number}}" src="{%if message.inbound%}{% static 'img/blank-profile-picture.png' %}{%else%}{%if message.user%}{{message.user.profile.avatar.url}}{%else%}{{message.site.company.first.company_logo_black.url}}{%endif%}{%endif%}" alt="" width="44" height="44" class="rounded-circle">
                    </div>
                    <div class="col p-0 ps-1">
                        <div class="row chat_lead_name_row">
                            <div class="col p-0" id="latest_message_name_{{message.customer_number}}">
                                {%if message.lead.name%}{{message.lead.name}}{%else%}{{message.customer_number}}{%endif%}
                            </div>
                        </div>
                        <div class="row chat_message_row">
                            <div class="col p-0" id="latest_message_content_{{message.customer_number}}">
                                {%if message.inbound%}Them{%else%}You{%endif%}: {{message.message}}
                            </div>
                        </div>
                    </div>
                </div>
                {%endfor%}
        </div>
    </div>
    {%else%}
    <div class="card card-body chat_bottom_window">
        <div class="card-header chat_bottom_header" >
            Select a site to chat
        </div>
    </div>
    {%endif%}
    {% comment %} <div class="container">
        <div class="row d-flex justify-content-center">
            <div class="col-3">
                <form>
                    <div class="form-group">
                        <label for="exampleFormControlTextarea1" class="h4 pt-5">Chatbox</label>
                        <textarea class="form-control" id="chat-text" readonly rows="10"></textarea><br>
                    </div>
                    <div class="form-group">
                        <input class="form-control" placeholder="Enter text here" id="input" type="text"></br>
                    </div>
                    <input class="btn btn-primary btn-lg btn-block" id="submit" type="button" value="Send">
                </form>
            </div>
        </div>
    </div> {% endcomment %}
    {% comment %} Get data for username and chatbox name{% endcomment %}
    {% comment %} {{ request.user.username|json_script:"user_username" }} {% endcomment %}