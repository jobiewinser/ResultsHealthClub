{% extends 'core/base.html' %}
{%load static%}
{%block scripts%}
{{block.super}}
<script>
    $(document).ready(function() {  
        initDataTable();
        document.body.addEventListener('htmx:beforeRequest', function(evt) {  
            if (evt.detail.target.id == 'overview_table' || evt.detail.pathInfo.path.includes("campaign-booking-overview")){
                $("#overview_table").dataTable().fnDestroy();
            }
        });
        document.body.addEventListener('htmx:afterSwap', function(evt) {   
            if (evt.detail.target.id == 'overview_table'){
                initDataTable(); 
            }
            else if (evt.detail.pathInfo.path.includes("modify-user")){
                $('#generic_modal').modal('hide');
                snackbarShow('Successfully modifed/added user', 'success')
            }            
            {% comment %} if (evt.detail.target.classList.contains('campaign_booking_row')) {
                $('#refresh_overview_table').click(); 
            } {% endcomment %}


            if (evt.detail.xhr.status == 200){
                if (evt.detail.pathInfo.path.includes("mark-done")){
                    snackbarShow('Successfully marked lead as done', 'success')
                } else if (evt.detail.pathInfo.path.includes("add-booking")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully added a booking', 'success')
                } else if (evt.detail.pathInfo.path.includes("log-communication")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully logged a communication', 'success')
                } else if (evt.detail.pathInfo.path.includes("create-campaign-lead")){
                    $('#refresh_overview_table').click(); 
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully manually created a campaign lead', 'success')
                } else if (evt.detail.pathInfo.path.includes("mark-arrived")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully marked that the customer arrived as booking', 'success')
                } else if (evt.detail.pathInfo.path.includes("mark-sold")){
                    $('#generic_modal').modal('hide');
                    snackbarShow('Successfully sold to customer', 'success')
                } else if (evt.detail.pathInfo.path.includes("campaign-booking-overview")){
                    $('#refresh_campaign_list_span').click(); 
                    snackbarShow('Successfully refreshed table', 'success')
                }                
            }
            if ($('#noteTable')){
                
            }
            $('[data-bs-toggle=popover]').popover();
        });
    });
    function initDataTable() {
        dt = $('#overview_table').DataTable(            
        {  
            order: [[ 4, 'asc' ],[ 2, 'asc' ]],
            iDisplayLength: 10
        }
        );
    }
</script>
{%endblock scripts%}

{%block overide_content%}       
<div class="col d-flex flex-column h-sm-100 p-0" style="overflow-x:hidden"> 
    <main class="row">
        <div class="row p-0 mt-2">
            {%block extra_top_left_buttons %}
            <div class="col-md-auto">
                <a class="btn btn-secondary" href="{%url 'customer-home'%}"><i class="fa-solid fa-arrow-left"></i> Back to Home</a>             
            </div>
            {%include 'core/htmx/site_selection.html'%}
            <button hidden hx-get="{% url 'campaign-booking-overview' %}" hx-push-url="true" hx-swap="outerHTML" hx-include=".non_site_dependant_overview_table_filters" hx-indicator=".top-htmx-indicator" hx-target="#overview_table" id="change_site" class="btn btn-primary btn-sm"></button>
            <button hidden
            hx-get="{{request.path}}" 
            hx-swap="outerHTML" hx-push-url="true" hx-include=".overview_table_filters" hx-indicator=".top-htmx-indicator" hx-target="#overview_table" id="filter_active_campaign_list" class="btn btn-primary btn-sm"></button>
            {{block.super}}
            <div class="col-md-auto" id="campaign_list_div">
                <span id="campaign_list_span" hx-get="{% url 'get-active-campaign-lists'%}" hx-include=".overview_table_filters" hx-trigger="load" hx-indicator=".top-htmx-indicator" hx-target="#campaign_list_span" hx-swap="outerHTML">   
                    <select class="form-select">
                        <option>Loading</option>
                    </select>    
                </span>
            </div>
            <button hidden hx-get="{% url 'get-active-campaign-lists'%}" hx-include=".overview_table_filters" id="refresh_campaign_list_span" hx-indicator=".top-htmx-indicator" hx-target="#campaign_list_div" hx-trigger="click" hx-swap="innerHTML"></button>
            <button hidden hx-get="{% url 'campaign-booking-overview'%}" hx-include=".overview_table_filters" id="refresh_overview_table" hx-indicator=".top-htmx-indicator" hx-target="#overview_table" hx-trigger="click" hx-swap="outerHTML"></button>
            {%endblock%}
            <div class="col">                
            </div>
            {%block extra_top_right_buttons %}
            {%include 'campaign_leads/htmx/campaign_bookings_table_status_toggle_div.html'%}
            {%include 'campaign_leads/htmx/campaign_bookings_table_booking_needed_toggle_div.html'%}
            {%endblock%}
        </div>
        <div class="row">
            <div class="col">
                {%block table%}

                    <span hx-swap-oob="true" id="site_pk_span">   
                        <input type="text" style="display:None" id="site_pk" name="site_pk" value="{{request.GET.site_pk}}"/>
                    </span>
                    <input type="text" style="display:None" id="log_communication" name="template_name" value="log_communication"/>
                    <input type="text" style="display:None" id="communication_history" name="template_name" value="communication_history"/>
                    <input type="text" style="display:None" id="booking_history" name="template_name" value="booking_history"/>
                    <input type="text" style="display:None" id="note_history" name="template_name" value="note_history"/>

                    <input type="text" style="display:None" id="add_booking" name="template_name" value="add_booking"/>
                    <input type="text" style="display:None" id="pause_whatsapp" name="template_name" value="pause_whatsapp"/>
                    <br>
                    <div class="card p-2">
                        {% include 'campaign_leads/htmx/campaign_bookings_table.html' %}
                    </div>
                {%endblock table%}
            </div>
        </div>
    </main>
</div>
    
{%endblock overide_content%}